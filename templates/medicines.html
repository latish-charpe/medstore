{% extends 'base.html' %}

{% block title %}Medicines{% endblock %}

{% block content %}
<div class="container">
    <div style="text-align: center; margin-bottom: 3rem;">
        <h1 style="color: var(--primary); margin-bottom: 1rem;">
            {% if current_category %}
            {{ current_category }}
            {% else %}
            Available Medicines
            {% endif %}
        </h1>
        <form action="{{ url_for('medicines') }}" method="GET" class="search-bar">
            <input type="text" id="search-input" name="search" class="form-control"
                placeholder="Search medicines by name..." value="{{ request.args.get('search', '') }}">
            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Search</button>
            {% if request.args.get('search') %}
            <a href="{{ url_for('medicines') }}" class="btn btn-secondary">Clear</a>
            {% endif %}
        </form>
    </div>

    <!-- Prescription Banner -->
    <div
        style="background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2.5rem; display: flex; align-items: center; justify-content: space-between; border: 1px solid #bbdefb; flex-wrap: wrap; gap: 1rem;">
        <div style="flex: 1; min-width: 280px;">
            <h3 style="color: var(--primary-dark); margin-bottom: 0.5rem;"><i class="fas fa-file-medical"></i> Order
                with Prescription</h3>
            <p style="color: var(--dark); font-size: 0.95rem;">Upload your prescription and we will assist you with the
                medicines. Simple & Quick.</p>
        </div>
        <div>
            <a href="{{ url_for('prescription_upload') }}" class="btn btn-secondary" style="white-space: nowrap;">
                <i class="fas fa-upload"></i> Upload Prescription
            </a>
        </div>
    </div>

    {% if medicines %}
    <div class="medicines-grid">
        {% for med in medicines %}
        <div class="medicine-card">
            <!-- Image & Badge -->
            <div class="medicine-header">
                <div style="width: 100%;">
                    <div
                        style="display: flex; justify-content: space-between; margin-bottom: 5px; align-items: flex-start;">
                        <div>
                            <span class="badge badge-success" style="background-color: #e3f2fd; color: #0d47a1;">{{
                                med.medicine_type }}</span>
                            <span class="badge badge-secondary"
                                style="background: #f8f9fa; color: #666; font-weight: 500;">{{ med.category.name
                                }}</span>
                        </div>
                        <div class="expiry-badge">
                            {% if med.expiry_status == 'Expired' %}
                            <span class="badge badge-danger">Expired</span>
                            {% elif med.expiry_status == 'Near Expiry' %}
                            <span class="badge badge-warning">Near Expiry</span>
                            {% else %}
                            <span class="badge badge-success"
                                style="background-color: #e8f5e9; color: #2e7d32;">Safe</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="medicine-name"
                        style="font-size: 1.1rem; min-height: auto; line-height: 1.4; margin-bottom: 5px; font-weight: 600;">
                        {{ med.name }}
                    </div>
                </div>
            </div>

            <div style="margin: 0 0 15px 0;">
                <div style="display: flex; justify-content: space-between; align-items: baseline;">
                    <div class="medicine-price">₹{{ med.price }}</div>
                    <span style="font-size: 0.85rem; color: var(--gray);">{{ med.unit }}</span>
                </div>
                <div style="font-size: 0.8rem; color: #757575; margin-top: 4px;">
                    <i class="far fa-calendar-alt"></i> Expiry: {{ med.expiry_date.strftime('%Y-%m-%d') }}
                </div>
                <div
                    style="font-size: 0.82rem; color: #444; margin-top: 10px; line-height: 1.4; border-top: 1px solid #eee; padding-top: 8px;">
                    <div style="font-weight: 700; color: var(--primary-dark); margin-bottom: 5px;">Formulation:</div>
                    {% if med.composition %}
                    {% set f = med.composition|parse_formulation %}
                    {% if f.ingredients %}
                    <div style="margin-bottom: 6px;">
                        <div style="font-weight: 600;">• Active Ingredient(s):</div>
                        {% for item in f.ingredients %}
                        <div style="padding-left: 12px; color: #555;">- {{ item }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if f.excipients %}
                    <div style="margin-bottom: 6px;">
                        <div style="font-weight: 600;">• Excipients:</div>
                        {% for item in f.excipients %}
                        <div style="padding-left: 12px; color: #555;">- {{ item }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if f.use %}
                    <div>
                        <div style="font-weight: 600;">• Use:</div>
                        {% for item in f.use %}
                        <div style="padding-left: 12px; color: #555;">- {{ item }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% else %}
                    <span style="color: var(--gray); font-style: italic;">Formulation information not available</span>
                    {% endif %}
                </div>
                {% if med.quantity <= 10 and med.quantity> 0 %}
                    <div style="font-size: 0.8rem; color: #e03131; margin-top: 5px;">
                        <i class="fas fa-fire"></i> Only {{ med.quantity }} left!
                    </div>
                    {% endif %}
            </div>

            <div style="margin-top: auto;">
                {% if med.quantity > 0 %}
                <form action="{{ url_for('add_to_cart', id=med.id) }}" method="POST"
                    style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
                    <div style="display: flex; gap: 10px;">
                        <select name="quantity" class="form-control" style="padding: 5px; width: 70px; height: 38px;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="5">5</option>
                        </select>
                        <button type="submit" name="action" value="add_to_cart" class="btn btn-sm btn-secondary"
                            style="flex: 1; border-radius: 6px; font-size: 0.9rem;">Add to Cart</button>
                    </div>
                    <button type="submit" name="action" value="buy_now" class="btn btn-sm btn-primary"
                        style="width: 100%; border-radius: 6px;">Buy Now</button>
                </form>
                {% else %}
                <button class="btn btn-sm btn-danger" style="width: 100%; border-radius: 6px;" disabled>
                    <i class="fas fa-times-circle"></i> Out of Stock
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div
        style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 10px; border: 1px dashed #dee2e6;">
        <i class="fas fa-pills" style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem;"></i>
        <p>No relevant medicine found. Please consult a doctor.</p>
    </div>
    {% endif %}
</div>

{% if request.args.get('action') == 'search' %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.focus();
            searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
</script>
{% endif %}
{% endblock %}